<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Animated CIM Markers</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.26/"></script>

    <script>
      require(["esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/layers/VectorTileLayer", "esri/Basemap", "esri/geometry/geometryEngine"], (Map, MapView, FeatureLayer, VectorTileLayer, Basemap, geometryEngine) => {
        const countries = new FeatureLayer({
          url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Countries_(Generalized)/FeatureServer"
        });

        const query = countries.createQuery();
        query.where = "COUNTRY='Switzerland'";
        query.returnGeometry = true;
        countries.queryFeatures(query).then((featureSet) => {
          surroundByArrows(featureSet.features[0]);
        });

        async function surroundByArrows(feature) {
          const geometry = feature.geometry;//geometryEngine.buffer(geometryEngine.generalize(feature.geometry, 20000), 30000);

          const featureLayer = new FeatureLayer({
            effect: "bloom(0.5, 0.1px, 15%)",
            renderer: {
              type: "simple",
              symbol: {
                type: "cim",
                data: {
                  type: "CIMSymbolReference",
                  symbol: {
                    type: "CIMLineSymbol",
                    symbolLayers: [
                      {
                        "type": "CIMPictureMarker",
                        "enable": true,
                        "anchorPointUnits": "Relative",
                        "dominantSizeAxis3D": "Y",
                        "size": 8,
                        "billboardMode3D": "FaceNearPlane",
                        "markerPlacement": {
                          "type": "CIMMarkerPlacementAlongLineSameSize",
                          "placePerPart": true,
                          "angleToLine": true,
                          "endings": "NoConstraint",
                          "placementTemplate": [
                            1
                          ]
                        },
                        "invertBackfaceTexture": true,
                        "scaleX": 1,
                        "textureFilter": "Picture",
                        "tintColor": [
                          210,
                          230,
                          250,
                          40
                        ],
                        "url": "images/pulse.gif",
                        animatedSymbolProperties: {
                          primitiveName: "Transfer"
                        }
                      }
                    ]
                  },
                  primitiveOverrides: [
                    {
                      type: "CIMPrimitiveOverride",
                      primitiveName: "Transfer",
                      propertyName: "Duration",
                      valueExpressionInfo: {
                        type: "CIMExpressionInfo",
                        expression: "1 / (0.1 + $feature.TransferRate)"
                      }
                    }
                  ]
                }
              }
            },
            source: [
              {
                geometry,
                attributes: {
                  OID: 1,
                  TransferRate: 1,
                  Name: "Some name..."
                }
              },
            ],
            objectIdField: "OID",
            fields: [
              {
                name: "TransferRate",
                type: "double"
              },
              {
                name: "StartDelay",
                type: "double"
              }
            ]
          });

          const basemap = new Basemap({
            baseLayers: [
              new VectorTileLayer({
                url: "https://www.arcgis.com/sharing/rest/content/items/5e9b3685f4c24d8781073dd928ebda50/resources/styles/root.json"
              })
            ]
          });

          const map = new Map({
            basemap,
            layers: [featureLayer]
          });

          const view = new MapView({
            container: "viewDiv",
            map: map,
            zoom: 6,
            center: [8.2275, 46.8182]
          });
        }
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>